#!/bin/bash
#
# Pre-commit hook to ensure PowerShell files have Windows (CRLF) line endings
#
# To install this hook, run:
#   git config core.hooksPath .githooks
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Checking PowerShell file line endings..."

# Get list of staged .ps1 files
PS1_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ps1$')

if [ -z "$PS1_FILES" ]; then
    echo -e "${GREEN}✓ No PowerShell files to check${NC}"
    exit 0
fi

# Check each PowerShell file for proper line endings
NEEDS_FIXING=""
for file in $PS1_FILES; do
    if [ -f "$file" ]; then
        # Check if file has CRLF line endings
        if ! file "$file" | grep -q "CRLF"; then
            echo -e "${RED}✗ $file has incorrect line endings (needs CRLF)${NC}"
            NEEDS_FIXING="$NEEDS_FIXING $file"
        else
            echo -e "${GREEN}✓ $file has correct line endings (CRLF)${NC}"
        fi
    fi
done

# If any files need fixing, abort commit and provide instructions
if [ -n "$NEEDS_FIXING" ]; then
    echo ""
    echo -e "${RED}ERROR: Some PowerShell files have incorrect line endings${NC}"
    echo ""
    echo "PowerShell files MUST use Windows (CRLF) line endings to work correctly on Windows."
    echo ""
    echo "To fix, run these commands:"
    echo ""
    for file in $NEEDS_FIXING; do
        echo "  sed -i 's/\$/\\r/' $file"
    done
    echo ""
    echo "Or use dos2unix tools:"
    echo "  unix2dos$NEEDS_FIXING"
    echo ""
    echo "Then stage the files again:"
    echo "  git add$NEEDS_FIXING"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ All PowerShell files have correct line endings${NC}"
exit 0
